<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>Hi all!</p> <p>Good night and happy holiday! Here I would like to share with all of you about something an interesting case study that maybe you‚Äôve done or come across soon.</p> <p>Imagine the Developer Team in your company is still doing Proof-of-Concept related to a specific project for the user, and the user is strict about the cost. The Dev Team is using EC2 Instance and the maximum budget for EC2 Instance is only $5 per day.</p> <p>You ‚Äîas an infrastructure engineer are tasked to create an alert when a budget amount is reached. The alert will send a notification via email, and at the same time the user wants any running EC2 Instance will automatically stop for further investigation. </p> <p>For this case, we will be using several services to make the goal is reached. The diagram is below:</p> <div class="wp-block-image"> <figure class="aligncenter size-large"><img loading="lazy" width="536" height="285" data-attachment-id="11012" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/aws-diagram-halaman-11-drawio/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/aws-diagram-halaman-11.drawio.png" data-orig-size="536,285" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="aws-diagram-halaman-11.drawio" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/aws-diagram-halaman-11.drawio.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/aws-diagram-halaman-11.drawio.png?w=536" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/aws-diagram-halaman-11.drawio.png?w=536" alt="" class="wp-image-11012" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/aws-diagram-halaman-11.drawio.png 536w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/aws-diagram-halaman-11.drawio.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/aws-diagram-halaman-11.drawio.png?w=300 300w" sizes="(max-width: 536px) 100vw, 536px"></figure> </div> <p>First, to ensure the team‚Äôs cost usage is under control and tracked easily, we are able to use AWS Budget. This service is provided by AWS and will show our maximum budget for all or specific services. We are also able to define the threshold and connect it to Amazon SNS (Simple Notification Service), so the team will be notified. For example, we defined the maximum budget as $2 per day, and the alarm was triggered when it reached 80%. This is really something interesting. We don‚Äôt necessarily check it manually, and the team is notified automatically via email (for example). </p> <p>How about a task to stop the EC2 Instance at the same time? Yup, AWS Lambda Function. We are able to use that service to ensure the EC2 instance is stopped when the alarm is triggered <img src="https://s0.wp.com/wp-content/mu-plugins/wpcom-smileys/twemoji/2/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;"></p> <p>Let‚Äôs break it down!</p> <p>First, we have to configure the notification using Amazon SNS. There are two components that we have to set up. Topic and Subscription. Topic is similar to a channel that will send a broadcast message to subscribers we defined in a subscription, for example email and AWS Lambda. Both will receive a notification when the budget amount is reached. </p> <p>To create a topic, you can follow the full guide here. The thing you must pay attention to is access policy. Add an additional policy so that Amazon SNS will get permission to publish a notification when the budget is reached. Below:</p> <pre class="wp-block-code"><code>{
  "Sid": "E.g., AWSBudgetsSNSPublishingPermissions",
  "Effect": "Allow",
  "Principal": {
    "Service": "budgets.amazonaws.com"
  },
  "Action": "SNS:Publish",
  "Resource": "your topic ARN",
   "Condition": {
        "StringEquals": {
          "aws:SourceAccount": "&lt;account-id&gt;"
        },
        "ArnLike": {
          "aws:SourceArn": "arn:aws:budgets::&lt;account-id&gt;:*"
        }
      }
}</code></pre> <p>Below is an example of topic I‚Äôve created:</p> <figure class="wp-block-image size-large"><img loading="lazy" width="983" height="426" data-attachment-id="10967" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_22-44_1/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png" data-orig-size="983,426" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_22-44_1" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png?w=983" alt="" class="wp-image-10967" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png 983w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44_1.png?w=768 768w" sizes="(max-width: 983px) 100vw, 983px"></figure> <p>For the first subscription, follow the guide <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-email-notifications.html" rel="external nofollow noopener" target="_blank">here</a> and ensure the email is confirmed. </p> <figure class="wp-block-image size-large"><img loading="lazy" width="966" height="374" data-attachment-id="10968" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_22-44/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png" data-orig-size="966,374" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_22-44" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png?w=966" alt="" class="wp-image-10968" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png 966w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-44.png?w=768 768w" sizes="(max-width: 966px) 100vw, 966px"></figure> <p>If the Amazon SNS is configured, we move on to the AWS Budget.</p> <p>From the Management Console, find an AWS Budget menu and just click <strong>create</strong> button. In this case, I‚Äôm using <strong>Customize</strong> and <strong>Cost budget </strong>type like the one below.</p> <div class="wp-block-image"> <figure class="aligncenter size-large"><img loading="lazy" width="678" height="438" data-attachment-id="10973" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_22-52/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-52.png" data-orig-size="678,438" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_22-52" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-52.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-52.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-52.png?w=678" alt="" class="wp-image-10973" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-52.png 678w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-52.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-52.png?w=300 300w" sizes="(max-width: 678px) 100vw, 678px"></figure> </div> <p>I‚Äôm set for the period is to daily, and the amount is $2.</p> <div class="wp-block-image"> <figure class="aligncenter size-large"><img loading="lazy" width="664" height="539" data-attachment-id="11019" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-24_00-12/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-24_00-12.png" data-orig-size="664,539" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-24_00-12" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-24_00-12.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-24_00-12.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-24_00-12.png?w=664" alt="" class="wp-image-11019" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-24_00-12.png 664w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-24_00-12.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-24_00-12.png?w=300 300w" sizes="(max-width: 664px) 100vw, 664px"></figure> </div> <p>For the budget scope, because in this case, the Dev team only using EC2 Instances, we can configure to filter EC2 Instances only.</p> <div class="wp-block-image"> <figure class="aligncenter size-large"><img loading="lazy" width="664" height="552" data-attachment-id="10977" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_22-57/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-57.png" data-orig-size="664,552" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_22-57" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-57.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-57.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-57.png?w=664" alt="" class="wp-image-10977" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-57.png 664w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-57.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_22-57.png?w=300 300w" sizes="(max-width: 664px) 100vw, 664px"></figure> </div> <p>We can define the specific threshold for the alert. Below the example, if the usage is reached 80% of the budgeted amount, it will send the notification.</p> <div class="wp-block-image"> <figure class="aligncenter size-large is-resized"><img loading="lazy" data-attachment-id="10979" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-01/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01.png" data-orig-size="695,573" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-01" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01.png?w=695" alt="" class="wp-image-10979" width="695" height="573" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01.png 695w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01.png?w=300 300w" sizes="(max-width: 695px) 100vw, 695px"></figure> </div> <p>Who will receive the notification? Put the ARN Amazon SNS that we created before in the form. Ensure it is valid.</p> <div class="wp-block-image"> <figure class="aligncenter size-large"><img loading="lazy" width="670" height="398" data-attachment-id="10981" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-01_1/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01_1.png" data-orig-size="670,398" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-01_1" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01_1.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01_1.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01_1.png?w=670" alt="" class="wp-image-10981" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01_1.png 670w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01_1.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-01_1.png?w=300 300w" sizes="(max-width: 670px) 100vw, 670px"></figure> </div> <p>Until this step, a team that has the email will get a notification when the budget amount is reached 80%. After this, we have to configure AWS Lambda. We have to create a function that will execute to stop the EC2 Instance when the alert is triggered.</p> <p>First, create a new policy and role in IAM so the AWS Lambda will have permission to stop EC2 Instance directly. Below is the policy in a JSON format:</p> <pre class="wp-block-code"><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeInstances",
                "ec2:DescribeRegions",
                "ec2:StopInstances",
                "ec2:DescribeInstanceStatus"
            ],
            "Resource": "*"
        }
    ]
}</code></pre> <p>The policy I‚Äôve created successfully:</p> <figure class="wp-block-image size-large"><img loading="lazy" width="1005" height="266" data-attachment-id="10989" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-15/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png" data-orig-size="1005,266" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-15" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png?w=1005" alt="" class="wp-image-10989" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png 1005w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-15.png?w=768 768w" sizes="(max-width: 1005px) 100vw, 1005px"></figure> <p>Below is the role I‚Äôve created successfully:</p> <figure class="wp-block-image size-large"><img loading="lazy" width="1018" height="273" data-attachment-id="10990" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-16/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png" data-orig-size="1018,273" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-16" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png?w=1018" alt="" class="wp-image-10990" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png 1018w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-16.png?w=768 768w" sizes="(max-width: 1018px) 100vw, 1018px"></figure> <p>For the function in AWS Lambda, I‚Äôm using Python 3.7 runtime and for the execution role, choose the existing role we created before. Here, my existing role name is <strong>StopEC2Instance.</strong></p> <div class="wp-block-image"> <figure class="aligncenter size-large"><img loading="lazy" width="1024" height="521" data-attachment-id="10992" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-19/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png" data-orig-size="1030,525" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-19" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png?w=1024" alt="" class="wp-image-10992" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png?w=1022 1022w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-19.png 1030w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> </div> <p>Below is the example code to stop EC2 instances. Paste into <strong>lambda_function.py </strong>editor.</p> <figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper"> <style>.gist table{margin-bottom:0}</style> <div style="tab-size: 8" id="gist120439525" class="gist"> <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light"> <div class="gist-data"> <div class="js-gist-file-update-container js-task-list-container"> <div id="file-stopec2instance-py" class="file my-2"> <div itemprop="text" class="Box-body p-0 blob-wrapper data type-python " style="overflow: auto" tabindex="0" role="region" aria-label="stopec2instance.py content, created by misskecupbung on 04:31PM on January 23, 2023."> <div class="js-check-hidden-unicode js-blob-code-container blob-code-content"> <template class="js-file-alert-template"> <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> <span> This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank" rel="external nofollow noopener">Learn more about bidirectional Unicode characters</a> </span> <div data-view-component="true" class="flash-action"> <a href="" data-view-component="true" class="btn-sm btn"> Show hidden characters </a> </div> </div></template> <template class="js-line-alert-template"> <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> </span></template> <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="stopec2instance.py"> <tr> <td id="file-stopec2instance-py-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td> <td id="file-stopec2instance-py-LC1" class="blob-code blob-code-inner js-file-line"> </td> </tr> <tr> <td id="file-stopec2instance-py-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td> <td id="file-stopec2instance-py-LC2" class="blob-code blob-code-inner js-file-line">import boto3</td> </tr> <tr> <td id="file-stopec2instance-py-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td> <td id="file-stopec2instance-py-LC3" class="blob-code blob-code-inner js-file-line"> </td> </tr> <tr> <td id="file-stopec2instance-py-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td> <td id="file-stopec2instance-py-LC4" class="blob-code blob-code-inner js-file-line">def GetInstanceRunning():</td> </tr> <tr> <td id="file-stopec2instance-py-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td> <td id="file-stopec2instance-py-LC5" class="blob-code blob-code-inner js-file-line"> client = boto3.client('ec2')</td> </tr> <tr> <td id="file-stopec2instance-py-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td> <td id="file-stopec2instance-py-LC6" class="blob-code blob-code-inner js-file-line"> ec2_regions = [region['RegionName'] for region in client.describe_regions()['Regions']]</td> </tr> <tr> <td id="file-stopec2instance-py-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td> <td id="file-stopec2instance-py-LC7" class="blob-code blob-code-inner js-file-line"> for region in ec2_regions:</td> </tr> <tr> <td id="file-stopec2instance-py-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td> <td id="file-stopec2instance-py-LC8" class="blob-code blob-code-inner js-file-line"> ec2 = boto3.resource('ec2')</td> </tr> <tr> <td id="file-stopec2instance-py-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td> <td id="file-stopec2instance-py-LC9" class="blob-code blob-code-inner js-file-line"> instances = ec2.instances.filter(Filters=[{'Name': 'instance-state-name', 'Values': ['running']}])</td> </tr> <tr> <td id="file-stopec2instance-py-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td> <td id="file-stopec2instance-py-LC10" class="blob-code blob-code-inner js-file-line"> return [instance.id for instance in instances]</td> </tr> <tr> <td id="file-stopec2instance-py-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td> <td id="file-stopec2instance-py-LC11" class="blob-code blob-code-inner js-file-line"> </td> </tr> <tr> <td id="file-stopec2instance-py-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td> <td id="file-stopec2instance-py-LC12" class="blob-code blob-code-inner js-file-line">def StopInstance(ids=GetInstanceRunning()):</td> </tr> <tr> <td id="file-stopec2instance-py-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td> <td id="file-stopec2instance-py-LC13" class="blob-code blob-code-inner js-file-line"> ec2 = boto3.client('ec2')</td> </tr> <tr> <td id="file-stopec2instance-py-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td> <td id="file-stopec2instance-py-LC14" class="blob-code blob-code-inner js-file-line"> if not ids:</td> </tr> <tr> <td id="file-stopec2instance-py-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td> <td id="file-stopec2instance-py-LC15" class="blob-code blob-code-inner js-file-line"> print("No Instance in the state Running or pending")</td> </tr> <tr> <td id="file-stopec2instance-py-L16" class="blob-num js-line-number js-blob-rnum" data-line-number="16"></td> <td id="file-stopec2instance-py-LC16" class="blob-code blob-code-inner js-file-line"> else:</td> </tr> <tr> <td id="file-stopec2instance-py-L17" class="blob-num js-line-number js-blob-rnum" data-line-number="17"></td> <td id="file-stopec2instance-py-LC17" class="blob-code blob-code-inner js-file-line"> ec2.stop_instances(InstanceIds=ids)</td> </tr> <tr> <td id="file-stopec2instance-py-L18" class="blob-num js-line-number js-blob-rnum" data-line-number="18"></td> <td id="file-stopec2instance-py-LC18" class="blob-code blob-code-inner js-file-line"> ec2.get_waiter('instance_stopped').wait(InstanceIds=ids)</td> </tr> <tr> <td id="file-stopec2instance-py-L19" class="blob-num js-line-number js-blob-rnum" data-line-number="19"></td> <td id="file-stopec2instance-py-LC19" class="blob-code blob-code-inner js-file-line"> print('instance {} was shutdown'.format(ids))</td> </tr> <tr> <td id="file-stopec2instance-py-L20" class="blob-num js-line-number js-blob-rnum" data-line-number="20"></td> <td id="file-stopec2instance-py-LC20" class="blob-code blob-code-inner js-file-line"> </td> </tr> <tr> <td id="file-stopec2instance-py-L21" class="blob-num js-line-number js-blob-rnum" data-line-number="21"></td> <td id="file-stopec2instance-py-LC21" class="blob-code blob-code-inner js-file-line">def lambda_handler(event, context):</td> </tr> <tr> <td id="file-stopec2instance-py-L22" class="blob-num js-line-number js-blob-rnum" data-line-number="22"></td> <td id="file-stopec2instance-py-LC22" class="blob-code blob-code-inner js-file-line"> StopInstance()</td> </tr> </table> </div> </div> </div> </div> </div> <div class="gist-meta"> <a href="https://gist.github.com/misskecupbung/0b2c5bec7d961d488e5c528c437b26e2/raw/c3edc681c4bb6dcb7a47dec153ab739016756753/stopec2instance.py" style="float:right" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank">view raw</a> <a href="https://gist.github.com/misskecupbung/0b2c5bec7d961d488e5c528c437b26e2#file-stopec2instance-py" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank"> stopec2instance.py </a> hosted with ‚ù§ by <a class="Link--inTextBlock" href="https://github.com" rel="external nofollow noopener" target="_blank">GitHub</a> </div> </div> </div> </div></figure> <p>Go to the <strong>Test</strong> tab and click <strong>Test</strong>. Wait for a moment, and below is the result. It shows that there is one instance is shutting down.</p> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="491" data-attachment-id="10999" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-39/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png" data-orig-size="1148,551" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-39" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png?w=1024" alt="" class="wp-image-10999" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png?w=1024 1024w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-39.png 1148w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p>Go to EC2 Instance, and the instance status is stopped <img src="https://s0.wp.com/wp-content/mu-plugins/wpcom-smileys/twemoji/2/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;"></p> <figure class="wp-block-image size-large"><img loading="lazy" width="903" height="157" data-attachment-id="11001" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-33/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png" data-orig-size="903,157" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-33" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png?w=903" alt="" class="wp-image-11001" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png 903w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-33.png?w=768 768w" sizes="(max-width: 903px) 100vw, 903px"></figure> <p>But wait! The function is run successfully when we click the Test button. How about ensuring that it will run when the budget is reached?</p> <p>Just add a new Trigger <img src="https://s0.wp.com/wp-content/mu-plugins/wpcom-smileys/twemoji/2/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;"></p> <figure class="wp-block-image size-large"><img loading="lazy" width="1019" height="463" data-attachment-id="11003" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-44/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png" data-orig-size="1019,463" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-44" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png?w=1019" alt="" class="wp-image-11003" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png 1019w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-44.png?w=768 768w" sizes="(max-width: 1019px) 100vw, 1019px"></figure> <p>Set a new trigger into Amazon SNS that we created before.</p> <figure class="wp-block-image size-large"><img loading="lazy" width="798" height="438" data-attachment-id="11005" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-45/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png" data-orig-size="798,438" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-45" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png?w=798" alt="" class="wp-image-11005" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png 798w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-45.png?w=768 768w" sizes="(max-width: 798px) 100vw, 798px"></figure> <p>It was added successfully, and whenever the alert rings, the function will automatically run to stop EC2 Instances.</p> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="421" data-attachment-id="11008" data-permalink="https://misskecupbung.wordpress.com/2023/01/24/aws-cloud-stop-an-ec2-instance-using-aws-lambda-when-the-budget-amount-is-reached/2023-01-23_23-47/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png" data-orig-size="1224,504" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="2023-01-23_23-47" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png?w=1024" alt="" class="wp-image-11008" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png?w=1022 1022w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2023/01/2023-01-23_23-47.png 1224w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p></p> <p></p> <p></p> <p>Thank you!</p> <p></p> <p></p> <p></p> <p>References:</p> <ol class="wp-block-list"> <li><a href="https://docs.aws.amazon.com/cost-management/latest/userguide/budgets-sns-policy.html" rel="external nofollow noopener" target="_blank">https://docs.aws.amazon.com/cost-management/latest/userguide/budgets-sns-policy.html</a></li> <li><a href="https://docs.aws.amazon.com/sns/latest/dg/sns-email-notifications.html" rel="external nofollow noopener" target="_blank">https://docs.aws.amazon.com/sns/latest/dg/sns-email-notifications.html</a></li> <li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/ec2-example-managing-instances.html" rel="external nofollow noopener" target="_blank">https://boto3.amazonaws.com/v1/documentation/api/latest/guide/ec2-example-managing-instances.html</a></li> </ol> <p></p> </body></html>