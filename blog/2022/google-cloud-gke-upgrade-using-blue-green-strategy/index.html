<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>Hi all!</p> <p>I hope that your day is good enough. In this journal, I would like to explain about Google Kubernetes (GKE) upgrade, specifically using Blue-Green Strategy.</p> <p>By default, GKE offers an automatic upgrade feature to our existing GKE cluster. We just have to make sure auto-upgrade is enabled, with a bit configuration, and the system will do an upgrade automatically. Sounds promising, right?</p> <p>That strategy has a lot of benefits. First, it is less effort and easy to use because we don‚Äôt have to manually track and update the versions. It has better security management because GKE will ensure that the security of the selected version is updated. </p> <p>But how about when we want to choose the specific version of Kubernetes for our existing cluster? For example, I want to use the newer version from the current version instead of the latest. How about our strategy when the automatic upgrade is still happening, but our application is crashing/failing, and we have to downgrade the version? </p> <p>From the documentation <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster" rel="external nofollow noopener" target="_blank">here</a>, downgrading a cluster is <strong>not recommended,</strong> and we cannot¬†downgrade a cluster control plane from one minor version to another. For example, if your control plane runs GKE version 1.17.17, you cannot downgrade to 1.16.15. If we attempt to do that, we will get an error. We can just downgrade 1.17.17 to 1.17.16, if that version is still available. </p> <p>The same thing will happen to node pool, based on the documentation <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-upgrades" rel="external nofollow noopener" target="_blank">here</a>. If we want to downgrade the worker‚Äôs node, we have to create a new node pool with the previous version, drain the workers which use the latest version, and delete it. Lots of effort and pain. </p> <p>So, what is the alternative? How do we avoid the pain and ensure the upgrading process is successful?</p> <p>We can do this by using the upgrade manually strategy <img src="https://s0.wp.com/wp-content/mu-plugins/wpcom-smileys/twemoji/2/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;"> </p> <p>Similar to common Kubernetes clusters, the manual upgrading process will consume more effort and time. But, we will have more control to ensure the upgrading process is successful and reduce the risk. </p> <p>Using a manual process, we can choose the specific version of the Kubernetes cluster instead of the latest. But, to be honest, it also has a limitation. We cannot upgrade the cluster to more than one minor version at a time. So, if our version cluster is <strong>1.22 </strong>and we want to upgrade to <strong>1.24, </strong>we have to upgrade to <strong>1.23 </strong>first and then upgrade it to <strong>1.24</strong>. The reference is <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades" rel="external nofollow noopener" target="_blank">here</a>.</p> <p>The limitation is similar to the Kubernetes provided by officials. But, one thing we have to remember is the version provided by GKE is limited. As this journal writes, the latest version of Kubernetes is <strong>1.25. </strong>But from the version provided by GKE is still <strong>1.24. </strong>Version <strong>1.25</strong> is still in rapid channel (pre-production), and we have to wait 2-3 months until it is ready to be used in production. </p> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="236" data-attachment-id="10833" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-23-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png" data-orig-size="1366,316" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-23" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=1024" alt="" class="wp-image-10833" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=1024 1024w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=1020 1020w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-23.png 1366w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p>GKE provided two strategies when we want to use a manual upgrade, <strong>SURGE </strong>(default) and <strong>BLUE-GREEN. </strong>What is the difference between both? The surge strategy uses a rolling method to upgrade nodes simultaneously in an undefined order. This strategy is better for our applications that tolerate disruptions until 60 minutes when graceful termination happens. </p> <p>So, when our applications are less tolerant of disruption, it is better to use the blue-green strategy. Other than that, blue-green strategy also offers to cancel, resume, roll back, and complete features. This is a great solution if our workloads fail and we need to be rolled back to the old node configuration. </p> <p>When we recap, the steps to do blue-green strategy upgrade are:</p> <ol class="wp-block-list"> <li>Upgrade the control-plane version to the newer version</li> <li>Create a new worker node pool (call it a green pool) with the same version as control plane</li> <li>Drain and cordon nodes in the blue node pool (node pool with the previous version)</li> <li>Migrates the applications to the green pool</li> <li>Delete the blue node pool</li> <li>Test and verify</li> </ol> <p>All right, let‚Äôs practice!</p> <p></p> <p>Let‚Äôs say I have a cluster named <strong>gke-dev1 </strong>in <strong>us-central1 </strong>region, and it uses <strong>1.22.12-gke.2300 </strong>for the version. </p> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="258" data-attachment-id="10829" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-21-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png" data-orig-size="1365,344" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-21" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png?w=1024" alt="" class="wp-image-10829" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png?w=1024 1024w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-21.png 1365w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p>By default, the upgrade strategy for node pool is <strong>SURGE </strong>which means</p> <figure class="wp-block-image size-large"><img loading="lazy" width="984" height="140" data-attachment-id="10830" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-22-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png" data-orig-size="984,140" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-22" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png?w=984" alt="" class="wp-image-10830" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png 984w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-22.png?w=768 768w" sizes="(max-width: 984px) 100vw, 984px"></figure> <p>And we need to change to <strong>blue-green </strong>strategy by using the command below:</p> <figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper"> <style>.gist table{margin-bottom:0}</style> <div style="tab-size: 8" id="gist118712053" class="gist"> <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light"> <div class="gist-data"> <div class="js-gist-file-update-container js-task-list-container"> <div id="file-blue-green-strategy-enable-gke" class="file my-2"> <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text " style="overflow: auto" tabindex="0" role="region" aria-label="blue-green-strategy-enable-gke content, created by misskecupbung on 07:27PM on October 05, 2022."> <div class="js-check-hidden-unicode js-blob-code-container blob-code-content"> <template class="js-file-alert-template"> <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> <span> This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank" rel="external nofollow noopener">Learn more about bidirectional Unicode characters</a> </span> <div data-view-component="true" class="flash-action"> <a href="" data-view-component="true" class="btn-sm btn"> Show hidden characters </a> </div> </div></template> <template class="js-line-alert-template"> <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> </span></template> <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="blue-green-strategy-enable-gke"> <tr> <td id="file-blue-green-strategy-enable-gke-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td> <td id="file-blue-green-strategy-enable-gke-LC1" class="blob-code blob-code-inner js-file-line">gcloud container node-pools update $NODE_POOL \</td> </tr> <tr> <td id="file-blue-green-strategy-enable-gke-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td> <td id="file-blue-green-strategy-enable-gke-LC2" class="blob-code blob-code-inner js-file-line">‚Äìcluster $CLUSTER_NAME \</td> </tr> <tr> <td id="file-blue-green-strategy-enable-gke-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td> <td id="file-blue-green-strategy-enable-gke-LC3" class="blob-code blob-code-inner js-file-line">‚Äìenable-blue-green-upgrade</td> </tr> </table> </div> </div> </div> </div> </div> <div class="gist-meta"> <a href="https://gist.github.com/misskecupbung/99542da3cbf61a246ca0eee64129f640/raw/b018a2a3c167aa87b37996c74985466ee102cf5f/blue-green-strategy-enable-gke" style="float:right" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank">view raw</a> <a href="https://gist.github.com/misskecupbung/99542da3cbf61a246ca0eee64129f640#file-blue-green-strategy-enable-gke" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank"> blue-green-strategy-enable-gke </a> hosted with ‚ù§ by <a class="Link--inTextBlock" href="https://github.com" rel="external nofollow noopener" target="_blank">GitHub</a> </div> </div> </div> </div></figure> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="268" data-attachment-id="10836" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-25-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png" data-orig-size="1073,281" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-25" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png?w=1024" alt="" class="wp-image-10836" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png?w=1024 1024w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-25.png 1073w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p>After that, upgrade the control plane:</p> <figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper"> <style>.gist table{margin-bottom:0}</style> <div style="tab-size: 8" id="gist118724659" class="gist"> <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light"> <div class="gist-data"> <div class="js-gist-file-update-container js-task-list-container"> <div id="file-upgrade-control-plane-gke" class="file my-2"> <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text " style="overflow: auto" tabindex="0" role="region" aria-label="upgrade-control-plane-gke content, created by misskecupbung on 02:24PM on October 06, 2022."> <div class="js-check-hidden-unicode js-blob-code-container blob-code-content"> <template class="js-file-alert-template"> <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> <span> This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank" rel="external nofollow noopener">Learn more about bidirectional Unicode characters</a> </span> <div data-view-component="true" class="flash-action"> <a href="" data-view-component="true" class="btn-sm btn"> Show hidden characters </a> </div> </div></template> <template class="js-line-alert-template"> <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> </span></template> <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="upgrade-control-plane-gke"> <tr> <td id="file-upgrade-control-plane-gke-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td> <td id="file-upgrade-control-plane-gke-LC1" class="blob-code blob-code-inner js-file-line">gcloud container clusters upgrade $CLUSTER_NAME \</td> </tr> <tr> <td id="file-upgrade-control-plane-gke-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td> <td id="file-upgrade-control-plane-gke-LC2" class="blob-code blob-code-inner js-file-line"> ‚Äìregion $GCP_REGION \</td> </tr> <tr> <td id="file-upgrade-control-plane-gke-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td> <td id="file-upgrade-control-plane-gke-LC3" class="blob-code blob-code-inner js-file-line"> ‚Äìcluster-version $NEW_K8S_VER \</td> </tr> <tr> <td id="file-upgrade-control-plane-gke-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td> <td id="file-upgrade-control-plane-gke-LC4" class="blob-code blob-code-inner js-file-line"> ‚Äìproject $PROJECT_ID \</td> </tr> <tr> <td id="file-upgrade-control-plane-gke-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td> <td id="file-upgrade-control-plane-gke-LC5" class="blob-code blob-code-inner js-file-line"> ‚Äìmaster</td> </tr> </table> </div> </div> </div> </div> </div> <div class="gist-meta"> <a href="https://gist.github.com/misskecupbung/9f69f5e295b3af198d9dcc8d9dcca167/raw/0dfa4e55f6ced6c238bfe3a986e4320101403b85/upgrade-control-plane-gke" style="float:right" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank">view raw</a> <a href="https://gist.github.com/misskecupbung/9f69f5e295b3af198d9dcc8d9dcca167#file-upgrade-control-plane-gke" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank"> upgrade-control-plane-gke </a> hosted with ‚ù§ by <a class="Link--inTextBlock" href="https://github.com" rel="external nofollow noopener" target="_blank">GitHub</a> </div> </div> </div> </div></figure> <p>Verify that the control plane is upgraded as below.</p> <figure class="wp-block-image size-large"><img loading="lazy" width="897" height="284" data-attachment-id="10838" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-26-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png" data-orig-size="897,284" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-26" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png?w=897" alt="" class="wp-image-10838" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png 897w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-26.png?w=768 768w" sizes="(max-width: 897px) 100vw, 897px"></figure> <p>After that, create a green node pool that uses the same version as the control plane node</p> <figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper"> <style>.gist table{margin-bottom:0}</style> <div style="tab-size: 8" id="gist118724944" class="gist"> <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light"> <div class="gist-data"> <div class="js-gist-file-update-container js-task-list-container"> <div id="file-create-green-node-pool-gke" class="file my-2"> <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text " style="overflow: auto" tabindex="0" role="region" aria-label="create-green-node-pool-gke content, created by misskecupbung on 02:39PM on October 06, 2022."> <div class="js-check-hidden-unicode js-blob-code-container blob-code-content"> <template class="js-file-alert-template"> <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> <span> This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank" rel="external nofollow noopener">Learn more about bidirectional Unicode characters</a> </span> <div data-view-component="true" class="flash-action"> <a href="" data-view-component="true" class="btn-sm btn"> Show hidden characters </a> </div> </div></template> <template class="js-line-alert-template"> <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> </span></template> <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="create-green-node-pool-gke"> <tr> <td id="file-create-green-node-pool-gke-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td> <td id="file-create-green-node-pool-gke-LC1" class="blob-code blob-code-inner js-file-line">gcloud container node-pools create pool-gke1-23 \</td> </tr> <tr> <td id="file-create-green-node-pool-gke-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td> <td id="file-create-green-node-pool-gke-LC2" class="blob-code blob-code-inner js-file-line"> ‚Äìproject $PROJECT_ID \</td> </tr> <tr> <td id="file-create-green-node-pool-gke-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td> <td id="file-create-green-node-pool-gke-LC3" class="blob-code blob-code-inner js-file-line"> ‚Äìcluster $CLUSTER_NAME \</td> </tr> <tr> <td id="file-create-green-node-pool-gke-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td> <td id="file-create-green-node-pool-gke-LC4" class="blob-code blob-code-inner js-file-line"> ‚Äìregion $GCP_REGION \</td> </tr> <tr> <td id="file-create-green-node-pool-gke-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td> <td id="file-create-green-node-pool-gke-LC5" class="blob-code blob-code-inner js-file-line"> ‚Äìnum-nodes $NUM_NODES \</td> </tr> <tr> <td id="file-create-green-node-pool-gke-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td> <td id="file-create-green-node-pool-gke-LC6" class="blob-code blob-code-inner js-file-line"> ‚Äìmachine-type $MACHINE_TYPE \</td> </tr> <tr> <td id="file-create-green-node-pool-gke-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td> <td id="file-create-green-node-pool-gke-LC7" class="blob-code blob-code-inner js-file-line"> ‚Äìnode-labels=nodepool=$NEW_GKE_VER</td> </tr> </table> </div> </div> </div> </div> </div> <div class="gist-meta"> <a href="https://gist.github.com/misskecupbung/13ff1e6d8906dc9167d6c7bcf23dda0f/raw/fb2c8a3354a159a49c8fc40c18b0119c1c7b0395/create-green-node-pool-gke" style="float:right" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank">view raw</a> <a href="https://gist.github.com/misskecupbung/13ff1e6d8906dc9167d6c7bcf23dda0f#file-create-green-node-pool-gke" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank"> create-green-node-pool-gke </a> hosted with ‚ù§ by <a class="Link--inTextBlock" href="https://github.com" rel="external nofollow noopener" target="_blank">GitHub</a> </div> </div> </div> </div></figure> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="208" data-attachment-id="10840" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-27-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png" data-orig-size="1155,235" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-27" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png?w=1024" alt="" class="wp-image-10840" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png?w=1024 1024w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-27.png 1155w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="225" data-attachment-id="10841" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-28-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png" data-orig-size="1366,301" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-28" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=1024" alt="" class="wp-image-10841" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=1024 1024w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=1021 1021w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-28.png 1366w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p>And then drain and cordon the blue node pool. This action ensures that new pods are not scheduled to the blue node pool. </p> <figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper"> <style>.gist table{margin-bottom:0}</style> <div style="tab-size: 8" id="gist118724886" class="gist"> <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light"> <div class="gist-data"> <div class="js-gist-file-update-container js-task-list-container"> <div id="file-drain-blue-node-pool-gke" class="file my-2"> <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text " style="overflow: auto" tabindex="0" role="region" aria-label="drain-blue-node-pool-gke content, created by misskecupbung on 02:35PM on October 06, 2022."> <div class="js-check-hidden-unicode js-blob-code-container blob-code-content"> <template class="js-file-alert-template"> <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> <span> This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank" rel="external nofollow noopener">Learn more about bidirectional Unicode characters</a> </span> <div data-view-component="true" class="flash-action"> <a href="" data-view-component="true" class="btn-sm btn"> Show hidden characters </a> </div> </div></template> <template class="js-line-alert-template"> <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> </span></template> <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="drain-blue-node-pool-gke"> <tr> <td id="file-drain-blue-node-pool-gke-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td> <td id="file-drain-blue-node-pool-gke-LC1" class="blob-code blob-code-inner js-file-line">NODE=$(kubectl get nodes -o wide | grep v1.22.12-gke.2300 | awk '{print $1}'</td> </tr> <tr> <td id="file-drain-blue-node-pool-gke-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td> <td id="file-drain-blue-node-pool-gke-LC2" class="blob-code blob-code-inner js-file-line">kubectl -n default cordon $NODE</td> </tr> </table> </div> </div> </div> </div> </div> <div class="gist-meta"> <a href="https://gist.github.com/misskecupbung/530e1d90070478eb4a181ceea153e1b2/raw/83bf62b9f75acb59e97dc7851cf27bf25e62b20b/drain-blue-node-pool-gke" style="float:right" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank">view raw</a> <a href="https://gist.github.com/misskecupbung/530e1d90070478eb4a181ceea153e1b2#file-drain-blue-node-pool-gke" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank"> drain-blue-node-pool-gke </a> hosted with ‚ù§ by <a class="Link--inTextBlock" href="https://github.com" rel="external nofollow noopener" target="_blank">GitHub</a> </div> </div> </div> </div></figure> <p>As we can see below, the node status is changed to <strong>SchedulingDisabled. </strong></p> <figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="282" data-attachment-id="10842" data-permalink="https://misskecupbung.wordpress.com/2022/10/06/google-cloud-gke-upgrade-using-blue-green-strategy/image-29-13/" data-orig-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png" data-orig-size="1366,377" data-comments-opened="1" data-image-meta='{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0"}' data-image-title="image-29" data-image-description="" data-image-caption="" data-medium-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png?w=300" data-large-file="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png?w=616" src="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png?w=1024" alt="" class="wp-image-10842" srcset="https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png?w=1022 1022w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png?w=150 150w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png?w=300 300w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png?w=768 768w, https://misskecupbung.wordpress.com/wp-content/uploads/2022/10/image-29.png 1366w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p>After this, we have to reschedule the applications into the green node pool. Make sure the applications is healthy, and then we delete the blue node pool.</p> <figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper"> <style>.gist table{margin-bottom:0}</style> <div style="tab-size: 8" id="gist118724916" class="gist"> <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light"> <div class="gist-data"> <div class="js-gist-file-update-container js-task-list-container"> <div id="file-delete-blue-node-pool-gke" class="file my-2"> <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text " style="overflow: auto" tabindex="0" role="region" aria-label="delete-blue-node-pool-gke content, created by misskecupbung on 02:37PM on October 06, 2022."> <div class="js-check-hidden-unicode js-blob-code-container blob-code-content"> <template class="js-file-alert-template"> <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> <span> This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank" rel="external nofollow noopener">Learn more about bidirectional Unicode characters</a> </span> <div data-view-component="true" class="flash-action"> <a href="" data-view-component="true" class="btn-sm btn"> Show hidden characters </a> </div> </div></template> <template class="js-line-alert-template"> <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e"> <svg aria-hidden="true" height="16" viewbox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert"> <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path> </svg> </span></template> <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="delete-blue-node-pool-gke"> <tr> <td id="file-delete-blue-node-pool-gke-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td> <td id="file-delete-blue-node-pool-gke-LC1" class="blob-code blob-code-inner js-file-line">gcloud container node-pools delete default-pool \</td> </tr> <tr> <td id="file-delete-blue-node-pool-gke-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td> <td id="file-delete-blue-node-pool-gke-LC2" class="blob-code blob-code-inner js-file-line"> ‚Äìproject $PROJECT_ID \</td> </tr> <tr> <td id="file-delete-blue-node-pool-gke-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td> <td id="file-delete-blue-node-pool-gke-LC3" class="blob-code blob-code-inner js-file-line"> ‚Äìcluster $CLUSTER_NAME \</td> </tr> <tr> <td id="file-delete-blue-node-pool-gke-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td> <td id="file-delete-blue-node-pool-gke-LC4" class="blob-code blob-code-inner js-file-line"> ‚Äìregion $GCP_REGION</td> </tr> </table> </div> </div> </div> </div> </div> <div class="gist-meta"> <a href="https://gist.github.com/misskecupbung/4ad559caf238b7d74b9ef338e8c7c399/raw/ac89cdd4d0684ec3c67c0d8dfa12d2aa22c90a92/delete-blue-node-pool-gke" style="float:right" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank">view raw</a> <a href="https://gist.github.com/misskecupbung/4ad559caf238b7d74b9ef338e8c7c399#file-delete-blue-node-pool-gke" class="Link--inTextBlock" rel="external nofollow noopener" target="_blank"> delete-blue-node-pool-gke </a> hosted with ‚ù§ by <a class="Link--inTextBlock" href="https://github.com" rel="external nofollow noopener" target="_blank">GitHub</a> </div> </div> </div> </div></figure> <p></p> <p></p> <p></p> <p>References:</p> <ol class="wp-block-list"> <li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades" rel="external nofollow noopener" target="_blank">https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades</a></li> <li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster" rel="external nofollow noopener" target="_blank">https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster</a></li> <li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies" rel="external nofollow noopener" target="_blank">https://cloud.google.com/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies</a></li> <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/" rel="external nofollow noopener" target="_blank">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</a></li> </ol> <p></p> <p></p> <p>Thank you!</p> <p></p> </body></html>